# This config was automatically generated from your source code
# Stacks detected: deps:java:.
version: 2.1
orbs:
  maven: circleci/maven@1.4.1
  browser-tools: circleci/browser-tools@1.4.8

jobs:
  build:
    docker:
      - image: cimg/openjdk:21.0
      - image: selenium/standalone-chrome:3.141.59-20200409
        environment:
          CI: true
    steps:
      - checkout
      - browser-tools/install-chrome
      - browser-tools/install-chromedriver
      - run:
          command:  |
            google-chrome --version
            chromedriver --version
      - run: mvn dependency:resolve
  smoke-test:
    docker:
      - image: cimg/openjdk:21.0
      - image: selenium/standalone-chrome:3.141.59-20200409
        environment:
          CI: true
    steps:
      - checkout
      - run: mvn dependency:resolve
      - run:
          name: Run tests
          command: mvn verify -Psmoke
      - run:
          name: Install Telegraf
          command: |
            # influxdata-archive_compat.key GPG fingerprint:
            #     9D53 9D90 D332 8DC7 D6C8 D3B9 D8FF 8E1F 7DF8 B07E
            wget -q https://repos.influxdata.com/influxdata-archive_compat.key
            echo '393e8779c89ac8d958f81f942f9ad7fb82a25e133faddaf92e15b16e6ac9ce4c influxdata-archive_compat.key' | sha256sum -c && cat influxdata-archive_compat.key | gpg --dearmor | sudo tee /etc/apt/trusted.gpg.d/influxdata-archive_compat.gpg > /dev/null
            echo 'deb [signed-by=/etc/apt/trusted.gpg.d/influxdata-archive_compat.gpg] https://repos.influxdata.com/debian stable main' | sudo tee /etc/apt/sources.list.d/influxdata.list
            sudo apt-get update && sudo apt-get install telegraf
      - run:
          name: start telegraf
          command: telegraf --config https://eu-central-1-1.aws.cloud2.influxdata.com/api/v2/telegrafs/0d03c1adaf7d0000
          background: true
      - run:
          name: Wait for Telegraf to start
          command: sleep 2
      - run: chmod +x .circleci/send_to_telegraf.sh
      - run:
          name: Post to telegraf
          command: .circleci/send_to_telegraf.sh


  sanity-test:
    docker:
      - image: cimg/openjdk:21.0
      - image: selenium/standalone-chrome:3.141.59-20200409
        environment:
          CI: true
    steps:
      - checkout
      - run: mvn dependency:resolve
      - run:
          name: Run tests
          command: mvn verify -Psanity
      - run:
          name: Install Telegraf
          command: |
            # influxdata-archive_compat.key GPG fingerprint:
            #     9D53 9D90 D332 8DC7 D6C8 D3B9 D8FF 8E1F 7DF8 B07E
            wget -q https://repos.influxdata.com/influxdata-archive_compat.key
            echo '393e8779c89ac8d958f81f942f9ad7fb82a25e133faddaf92e15b16e6ac9ce4c influxdata-archive_compat.key' | sha256sum -c && cat influxdata-archive_compat.key | gpg --dearmor | sudo tee /etc/apt/trusted.gpg.d/influxdata-archive_compat.gpg > /dev/null
            echo 'deb [signed-by=/etc/apt/trusted.gpg.d/influxdata-archive_compat.gpg] https://repos.influxdata.com/debian stable main' | sudo tee /etc/apt/sources.list.d/influxdata.list
            sudo apt-get update && sudo apt-get install telegraf
      - run:
          name: start telegraf
          command: telegraf --config https://eu-central-1-1.aws.cloud2.influxdata.com/api/v2/telegrafs/0d03c1adaf7d0000
          background: true
      - run:
          name: Wait for Telegraf to start
          command: sleep 10
      - run: chmod +x .circleci/send_to_telegraf.sh
      - run:
          name: Post to telegraf
          command: .circleci/send_to_telegraf.sh

  regression-test:
    docker:
      - image: cimg/openjdk:21.0
      - image: selenium/standalone-chrome:3.141.59-20200409
        environment:
          CI: true
    steps:
      - checkout
      - run: mvn dependency:resolve
      - run:
          name: Run tests
          command: mvn verify -Pregression
      - run:
          name: Install Telegraf
          command: |
            # influxdata-archive_compat.key GPG fingerprint:
            #     9D53 9D90 D332 8DC7 D6C8 D3B9 D8FF 8E1F 7DF8 B07E
            wget -q https://repos.influxdata.com/influxdata-archive_compat.key
            echo '393e8779c89ac8d958f81f942f9ad7fb82a25e133faddaf92e15b16e6ac9ce4c influxdata-archive_compat.key' | sha256sum -c && cat influxdata-archive_compat.key | gpg --dearmor | sudo tee /etc/apt/trusted.gpg.d/influxdata-archive_compat.gpg > /dev/null
            echo 'deb [signed-by=/etc/apt/trusted.gpg.d/influxdata-archive_compat.gpg] https://repos.influxdata.com/debian stable main' | sudo tee /etc/apt/sources.list.d/influxdata.list
            sudo apt-get update && sudo apt-get install telegraf
      - run:
          name: start telegraf
          command: telegraf --config https://eu-central-1-1.aws.cloud2.influxdata.com/api/v2/telegrafs/0d03c1adaf7d0000
          background: true
      - run:
          name: Wait for Telegraf to start
          command: sleep 10
      - run: chmod +x .circleci/send_to_telegraf.sh
      - run:
          name: Post to telegraf
          command: .circleci/send_to_telegraf.sh

workflows:
  build-and-test:
    jobs:
      - build
      - smoke-test:
          requires:
            - build
      - sanity-test:
          requires:
            - build
            - smoke-test
      - regression-test:
          requires:
            - build
            - sanity-test