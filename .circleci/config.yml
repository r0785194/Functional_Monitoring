# This config was automatically generated from your source code
# Stacks detected: deps:java:.
version: 2.1
orbs:
  maven: circleci/maven@1.4.1
  browser-tools: circleci/browser-tools@1.4.8
jobs:
  build:
    docker:
      - image: cimg/openjdk:21.0
      - image: selenium/standalone-chrome:3.141.59-20200409
        environment:
          CI: true
    steps:
      - checkout
      - browser-tools/install-chrome
      - browser-tools/install-chromedriver
      # Setup remote Docker environment
      - setup_remote_docker
      # Create Docker network
      - run: docker network create influxdb-network
      # Run InfluxDB container
      - run: docker run -d --name influxdb --network influxdb-network -p 8086:8086 -v influxdb-data:/var/lib/influxdb influxdb
      # Run Grafana container
      - run: docker run -d --name grafana --network influxdb-network -p 3000:3000 grafana/grafana
      - run:
          command:  |
            google-chrome --version
            chromedriver --version
      - run: mvn dependency:resolve
  smoke-test:
    docker:
      - image: cimg/openjdk:21.0
      - image: selenium/standalone-chrome:3.141.59-20200409
        environment:
          CI: true
    steps:
      - checkout
      - run: mvn dependency:resolve
      - run:
          name: Run tests
          command: mvn verify -Psmoke
      # Setup remote Docker environment
      - setup_remote_docker
      - run:
          name: Setup custom environment variables
          command: echo 'export TEST_FILE_PATH="/c/Users/Laura/Documents/Stage/Functional_Monitoring/target/surefire-reports/TEST-Setup.RunnerTest.xml"' >> "$BASH_ENV"
      - run:
          name: Set environment variables
          command: echo $TEST_FILE_PATH
#      - run:
#          name: Save secret value to file
#          command: echo "$TEST_FILE_PATH" > test_file_path.txt
      # Run Telegraf container
      - run: docker run -d --name telegraf --network influxdb-network --mount type=bind,source="$TEST_FILE_PATH",target=/etc/telegraf-xml -v telegraf-config:/etc/telegraf telegraf
      - run:
          name: Wait for Telegraf logs
          command: bash telegraf-monitor.sh wait_for_log_line telegraf "\[outputs.influxdb_v2\] Wrote batch of"

      - run:
          name: Stop Telegraf container
          command: bash telegraf-monitor.sh stop_container telegraf

  sanity-test:
    docker:
      - image: cimg/openjdk:21.0
      - image: selenium/standalone-chrome:3.141.59-20200409
        environment:
          CI: true
    steps:
      - checkout
      - run: mvn dependency:resolve
      - run:
          name: Run tests
          command: mvn verify -Psanity
      - run: docker start telegraf
      - run:
          name: Wait for Telegraf logs
          command: bash telegraf-monitor.sh wait_for_log_line telegraf "\[outputs.influxdb_v2\] Wrote batch of"

      - run:
          name: Stop Telegraf container
          command: bash telegraf-monitor.sh stop_container telegraf

  regression-test:
    docker:
      - image: cimg/openjdk:21.0
      - image: selenium/standalone-chrome:3.141.59-20200409
        environment:
          CI: true
    steps:
      - checkout
      - run: mvn dependency:resolve
      - run:
          name: Run tests
          command: mvn verify -Pregression
      - run: docker start telegraf
      - run:
          name: Wait for Telegraf logs
          command: bash telegraf-monitor.sh wait_for_log_line telegraf "\[outputs.influxdb_v2\] Wrote batch of"

      - run:
          name: Stop Telegraf container
          command: bash telegraf-monitor.sh stop_container telegraf

workflows:
  build-and-test:
    jobs:
      - build
      - smoke-test:
          requires:
            - build
      - sanity-test:
          requires:
            - build
            - smoke-test
      - regression-test:
          requires:
            - build
            - sanity-test