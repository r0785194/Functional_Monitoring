# This config was automatically generated from your source code
# Stacks detected: deps:java:.
version: 2.1
orbs:
  maven: circleci/maven@1.4.1
  browser-tools: circleci/browser-tools@1.4.8
jobs:
  build:
    docker:
      - image: cimg/openjdk:21.0
      - image: selenium/standalone-chrome:3.141.59-20200409
        environment:
          CI: true
    steps:
      - checkout
      - browser-tools/install-chrome
      - browser-tools/install-chromedriver
      - setup_remote_docker
      - run:
          command: docker --version
      - run:
          command: docker network create influxdb-network
                   docker run -d --name grafana -p 3000:3000 --network influxdb-network grafana/grafana
      #      - run:
#          command: docker restart influxdb
      - run:
          command:  |
            google-chrome --version
            chromedriver --version
      - run: mvn dependency:resolve
  smoke-test:
    docker:
      - image: cimg/openjdk:21.0
      - image: selenium/standalone-chrome:3.141.59-20200409
        environment:
          CI: true
    steps:
      - checkout
      - run: mvn dependency:resolve
      - run:
          name: Run tests
          command: mvn verify -Psmoke
      - run:
          name: Run tests and check logs
          command: |
            # Start de telegraf-container
            docker restart telegraf
            
            # Continu controleren op logboekregels en stop de container als de regel wordt gevonden
            docker logs -f telegraf-container | \
              while IFS= read -r line; do
                if [[ "$line" == *"[outputs.influxdb_v2] Wrote batch"* ]]; then
                  echo "Found: $line"
                  docker stop telegraf
                  break
                fi
              done

  sanity-test:
    docker:
      - image: cimg/openjdk:21.0
      - image: selenium/standalone-chrome:3.141.59-20200409
        environment:
          CI: true
    steps:
      - checkout
      - run: mvn dependency:resolve
      - run:
          name: Run tests
          command: mvn verify -Psanity

  regression-test:
    docker:
      - image: cimg/openjdk:21.0
      - image: selenium/standalone-chrome:3.141.59-20200409
        environment:
          CI: true
    steps:
      - checkout
      - run: mvn dependency:resolve
      - run:
          name: Run tests
          command: mvn verify -Pregression

workflows:
  build-and-test:
    jobs:
      - build
      - smoke-test:
          requires:
            - build
      - sanity-test:
          requires:
            - build
            - smoke-test
      - regression-test:
          requires:
            - build
            - sanity-test